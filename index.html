<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Genesys Cloud – Email Bulk Actions (Implicit, Preset)</title>
  <style>
    :root { --bg:#0b0d10; --card:#11151a; --muted:#9aa4b2; --text:#e6edf3; --accent:#77b6ff; --bad:#ff6b7a; --good:#2ec27e; }
    html, body { height: 100%; background: var(--bg); color: var(--text); }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin: 0; }
    .banner { background:#12263a; padding:10px 16px; text-align:center; border-bottom:1px solid #21344c; }
    .banner strong { color:#9effb3; }
    .container { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    .card { background: var(--card); border: 1px solid #1f2630; border-radius: 16px; box-shadow: 0 10px 20px rgba(0,0,0,.35); }
    .header { padding: 20px 20px 0 20px; display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
    .title { font-weight: 700; font-size: 20px; letter-spacing: .2px; }
    .content { padding: 20px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    label { font-size: 12px; color: var(--muted); display:block; margin-bottom: 6px; }
    input, select, textarea, button { width: 100%; box-sizing: border-box; border-radius: 10px; border: 1px solid #263041; background: #0e1217; color: var(--text); padding: 10px 12px; }
    textarea { resize: vertical; min-height: 80px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background: #0a0d11; }
    button { background: #1a2330; cursor: pointer; }
    button:hover { background:#1e2a3a; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .muted { color: var(--muted); font-size: 12px; }
    .pill { display:inline-flex; align-items:center; gap:8px; border:1px solid #2a3446; padding:8px 10px; border-radius: 999px; background:#0e1217; font-size: 12px; }
    .ok { color: var(--good); }
    .err { color: var(--bad); white-space: pre-wrap; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding: 8px 6px; border-bottom: 1px solid #253248; vertical-align: top; font-size: 13px; }
    th { text-align:left; color: var(--muted); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body>
  <div class="banner"><strong>Implicit Grant</strong> — Preset Region & Client; queues loaded from API</div>
  <div class="container">
    <div class="card">
      <div class="header">
        <div class="title">Email Bulk Actions</div>
        <div class="row" style="max-width:520px">
          <button id="signinBtn" class="nowrap">Sign in with Genesys Cloud</button>
          <button id="signoutBtn" class="nowrap" style="display:none">Sign out</button>
        </div>
      </div>
      <div class="content">
        <div class="row">
          <div style="flex:2">
            <label>OAuth Access Token</label>
            <input id="token" readonly placeholder="Sign in to populate automatically" />
            <div class="muted" id="whoami"></div>
          </div>
          <div style="flex:1">
            <label>Queue</label>
            <select id="queueSelect" disabled>
              <option value="" disabled selected>Sign in first</option>
            </select>
            <div class="muted" id="queueCount"></div>
          </div>
          <div style="flex:1">
            <label>Wrap-up code</label>
            <select id="wrapupSelect" disabled>
              <option value="" disabled selected>Select a queue first</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <button id="refreshBtn" disabled>Refresh Emails</button>
          <button id="assignMeBtn" disabled>Assign to me</button>
          <div class="row" style="flex:2">
            <div style="flex:1">
              <label class="muted">Filter by Subject</label>
              <input id="filterSubject" placeholder="Type to filter…" />
            </div>
            <div style="flex:1">
              <label class="muted">Filter by From</label>
              <input id="filterFrom" placeholder="Type to filter…" />
            </div>
          </div>
          <div class="row" style="flex:1">
            <div style="flex:1">
              <label class="muted">Transfer to user</label>
              <select id="userSelect" disabled>
                <option value="" disabled selected>Load users…</option>
              </select>
            </div>
            <div style="align-self:flex-end">
              <button id="loadUsersBtn" disabled>Load Users</button>
            </div>
            <div style="align-self:flex-end">
              <button id="transferBtn" disabled>Transfer to selected</button>
            </div>
          </div>
          <button id="wrapDiscBtn" disabled style="background:#52202a">Wrap-up + Disconnect</button>
        </div>

        <div class="muted" style="margin-top:6px">Lists <span class="pill">in-progress</span> email interactions from the selected queue (last 2 hours).</div>

        <div style="margin-top:12px; max-height:52vh; overflow:auto">
          <table>
            <thead>
              <tr>
                <th style="width:26px"><input type="checkbox" id="checkAll" /></th>
                <th>Subject</th>
                <th>From</th>
                <th>ConversationId</th>
                <th>Agent/ACD ParticipantId</th>
                <th>CommId</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>

        <div style="margin-top:12px">
          <label>Run Log</label>
          <textarea id="log" rows="8" readonly></textarea>
        </div>
        <div style="margin-top:8px" id="errors" class="err"></div>
      </div>
    </div>
  </div>

  <script>
    // ======== CONFIG (Preset) ========
    // Set these to your OAuth client + region. No UI prompts for region/redirect are shown.
    var REGION_HOST  = "mypurecloud.jp"; // Tokyo
    var CLIENT_ID    = "5ad8dc1d-2ee1-41dd-9771-1c0e58f22203";
    var REDIRECT_URI = window.location.origin + window.location.pathname; // or set to your exact allowed URL
    var OAUTH_STATE  = "email_bulk_implicit";
    // =================================

    var $ = function(id){ return document.getElementById(id); };
    var token = "";
    var baseUrl = function(){ return "https://api." + REGION_HOST; };

    function log(line){
      var stamp = new Date().toLocaleTimeString();
      var t = $("log");
      t.value = (t.value ? t.value + "
" : "") + stamp + " • " + line;
      t.scrollTop = t.scrollHeight;
    }
    function setError(msg){ $("errors").textContent = msg || ""; }
    function clearError(){ setError(""); }

    function buildAuthUrl(){
      var base = "https://login." + REGION_HOST + "/oauth/authorize";
      var params = new URLSearchParams({ client_id: CLIENT_ID, response_type: "token", redirect_uri: REDIRECT_URI, state: OAUTH_STATE });
      return base + "?" + params.toString();
    }
    function readTokenFromHash(){
      if (!location.hash) return null;
      var p = new URLSearchParams(location.hash.substring(1));
      var t = p.get("access_token");
      var exp = p.get("expires_in");
      if (t) history.replaceState({}, document.title, window.location.pathname + window.location.search);
      return t ? { access_token: t, expires_in: exp ? parseInt(exp,10) : null } : null;
    }

    function updateSigninState(){
      var signedIn = !!token;
      $("signinBtn").style.display = signedIn ? "none" : "inline-block";
      $("signoutBtn").style.display = signedIn ? "inline-block" : "none";
      ["refreshBtn","assignMeBtn","transferBtn","loadUsersBtn"].forEach(id => $(id).disabled = !signedIn);
      $("queueSelect").disabled = !signedIn;
      $("wrapupSelect").disabled = !signedIn || !$("queueSelect").value;
      $("wrapDiscBtn").disabled = !signedIn || !$("queueSelect").value;
      $("userSelect").disabled = !signedIn;
      $("token").value = token || "";
    }

    $("signinBtn").addEventListener("click", function(){
      try {
        if (!CLIENT_ID || CLIENT_ID === "REPLACE_WITH_CLIENT_ID") {
          alert("Set CLIENT_ID at top of the file.");
          return;
        }
        // Log what we're about to open (helps diagnose popup blockers / bad URLs)
        const url = buildAuthUrl();
        console.log("Redirecting to:", url);
        log("Opening Genesys Cloud login…");
        // Top-level navigation (no popup)
        window.location.assign(url);
      } catch (e) {
        setError(e && e.message ? e.message : String(e));
      }
    });
    $("signoutBtn").addEventListener("click", function(){ token=""; $("rows").innerHTML=""; $("queueSelect").innerHTML='<option disabled selected>Sign in first</option>'; $("wrapupSelect").innerHTML='<option disabled selected>Select a queue first</option>'; updateSigninState(); $("whoami").textContent=""; $("queueCount").textContent=""; $("log").value=""; $("userSelect").innerHTML='<option value="" disabled selected>Load users…</option>'; });

    window.addEventListener("error", function(e){ setError((e&&e.message)? e.message: "Script error"); });
    window.addEventListener("unhandledrejection", function(e){ setError("Promise rejection: " + (e.reason && e.reason.message ? e.reason.message : String(e.reason))); });

    (function init(){
      var th = readTokenFromHash();
      if (th) { token = th.access_token; }
      updateSigninState();
      if (token) bootstrap();
      $("queueSelect").addEventListener("change", function(){ loadWrapupsForQueue(this.value); $("wrapupSelect").disabled = !this.value; $("wrapDiscBtn").disabled = !this.value; filterRows(); });
      $("refreshBtn").addEventListener("click", refreshEmails);
      $("assignMeBtn").addEventListener("click", assignToMe);
      $("transferBtn").addEventListener("click", transferToUser);
      $("loadUsersBtn").addEventListener("click", loadUsers);
      $("wrapDiscBtn").addEventListener("click", wrapupAndDisconnect);
      $("checkAll").addEventListener("change", function(e){ document.querySelectorAll('#rows input[type="checkbox"]').forEach(cb => cb.checked = e.target.checked); });
      $("filterSubject").addEventListener("input", filterRows);
      $("filterFrom").addEventListener("input", filterRows);
    })();

    async function api(path, init){
      if (!token) throw new Error("Missing OAuth token");
      var res = await fetch(baseUrl() + path, Object.assign({}, init||{}, { headers: Object.assign({ "Authorization":"Bearer "+token, "Content-Type":"application/json" }, (init&&init.headers)||{}) }));
      if (!res.ok){ var text = await res.text(); throw new Error(res.status + " " + res.statusText + ": " + text); }
      return res.json();
    }

    async function bootstrap(){
      try {
        var me = await api("/api/v2/users/me");
        $("whoami").textContent = `Signed in as ${me.name} (${me.id}) · ${REGION_HOST}`;
        log("Authenticated");
        $("loadUsersBtn").disabled = false;
        await loadQueues();
      } catch(e){ setError(e.message||String(e)); }
    }

    async function loadQueues(){
      clearError();
      $("queueSelect").innerHTML = '<option value="" disabled selected>Loading…</option>';
      try {
        var items = []; var page=1, pageSize=100, data;
        do {
          data = await api(`/api/v2/routing/queues?pageSize=${pageSize}&pageNumber=${page}`);
          if (data && Array.isArray(data.entities)) { data.entities.forEach(q => items.push({ id:q.id, name:q.name })); }
          page++;
        } while (data && data.pageCount && page <= data.pageCount);
        items.sort((a,b)=>a.name.localeCompare(b.name));
        $("queueSelect").innerHTML = ['<option value="" disabled selected>Choose a queue</option>'].concat(items.map(q=>`<option value="${q.id}">${q.name}</option>`)).join("");
        $("queueCount").textContent = items.length ? (items.length + " queues loaded") : "No queues";
        updateSigninState();
      } catch(e){ setError(e.message||String(e)); $("queueSelect").innerHTML = '<option disabled selected>Error loading queues</option>'; }
    }

    async function loadWrapupsForQueue(queueId){
      $("wrapupSelect").innerHTML = '<option value="" disabled selected>Loading…</option>';
      try {
        // Only codes assigned to this queue
        var items = []; var page=1, pageSize=100, data;
        do {
          data = await api(`/api/v2/routing/queues/${queueId}/wrapupcodes?pageSize=${pageSize}&pageNumber=${page}`);
          if (data && Array.isArray(data.entities)) { data.entities.forEach(c => items.push({ id:c.id, name:c.name })); }
          page++;
        } while (data && data.pageCount && page <= data.pageCount);
        if (!items.length){ $("wrapupSelect").innerHTML = '<option value="" disabled selected>No wrap-up codes on this queue</option>'; return; }
        items.sort((a,b)=>a.name.localeCompare(b.name));
        $("wrapupSelect").innerHTML = ['<option value="" disabled selected>(choose wrap-up code)</option>']
          .concat(items.map(c=>`<option value="${c.id}">${c.name} — ${c.id}</option>`)).join("");
      } catch(e){ setError(e.message||String(e)); $("wrapupSelect").innerHTML = '<option disabled selected>Wrap-up codes unavailable</option>'; }
    }

    function selectedRows(){ return Array.from(document.querySelectorAll('#rows tr')).filter(tr => tr.querySelector('input[type="checkbox"]').checked).map(tr => JSON.parse(tr.dataset.payload)); }

    async function refreshEmails(){
      var queueId = $("queueSelect").value; if (!queueId){ log("Pick a queue first"); return; }
      $("rows").innerHTML = ""; log("Loading emails…");
      try {
        var end = new Date().toISOString();
        var start = new Date(Date.now() - 2*60*60*1000).toISOString();
        // queueId is a SEGMENT dimension
        var body = { interval: `${start}/${end}`, order:'desc', orderBy:'conversationStart', paging:{ pageNumber:1, pageSize:100 }, segmentFilters:[ { type:'and', predicates:[ { type:'dimension', dimension:'queueId', operator:'matches', value: queueId }, { type:'dimension', dimension:'mediaType', operator:'matches', value:'email' } ] } ] };
        var res = await fetch(baseUrl()+"/api/v2/analytics/conversations/details/query", { method:"POST", headers:{ "Authorization":"Bearer "+token, "Content-Type":"application/json" }, body: JSON.stringify(body) });
        if (!res.ok){ throw new Error(res.status+" "+res.statusText+": "+ await res.text()); }
        var data = await res.json();
        var rows = ((data && data.conversations) || []).filter(c => !c.conversationEnd).map(marshalRow);
        rows.forEach(addRow);
        log(`Loaded ${rows.length} in-progress emails`);
        $("checkAll").checked = false;
        filterRows();
      } catch(e){ setError(e.message||String(e)); }
    }

    function marshalRow(c){
      var parts = c.participants || [];
      var external = parts.find(p=>p.purpose==='external');
      var agent = parts.find(p=>p.purpose==='agent' || p.purpose==='user');
      var acd = parts.find(p=>p.purpose==='acd');
      var aSess = agent && (agent.sessions||[]).find(s=>s.mediaType==='email');
      var acdSess = acd && (acd.sessions||[]).find(s=>s.mediaType==='email');
      var comm = aSess || acdSess || null;
      return {
        conversationId: c.conversationId,
        subject: (comm && (comm.subject || comm.emailSubject)) || '',
        from: (external && (external.address || external.email || external.name)) || '',
        // Prefer participant that owns the email comm; fall back to whichever exists
        agentParticipantId: (agent && agent.participantId) || null,
        acdParticipantId: (acd && acd.participantId) || null,
        emailCommId: (comm && (comm.sessionId || comm.communicationId)) || null,
        owner: aSess ? 'agent' : (acdSess ? 'acd' : null)
      };
    }

    function addRow(r){
      var tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="checkbox"></td>
        <td class="cell-subject">${esc(r.subject||'')}</td>
        <td class="cell-from">${esc(r.from||'')}</td>
        <td class="mono">${esc(r.conversationId)}</td>
        <td class="mono">${esc(r.agentParticipantId || r.acdParticipantId || '')}</td>
        <td class="mono">${esc(r.emailCommId || '')}</td>`;
      tr.dataset.payload = JSON.stringify(r);
      $("rows").appendChild(tr);
      if (!r.subject || !r.from) enrichRowDetails(r.conversationId, tr); // async enrichment
    }

    function esc(s){ return (s||'').toString().replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

    async function assignToMe(){
      var sel = selectedRows(); if (!sel.length){ log('Select at least one row'); return; }
      try {
        var me = await api('/api/v2/users/me');
        var ok=0,fail=0;
        for (var r of sel){
          try {
            var holder = r.agentParticipantId || r.acdParticipantId; if (!holder){ fail++; continue; }
            await fetch(baseUrl()+`/api/v2/conversations/emails/${r.conversationId}/participants/${holder}/replace`, { method:'POST', headers:{ 'Authorization':'Bearer '+token, 'Content-Type':'application/json' }, body: JSON.stringify({ userId: me.id, transferType:'Unattended' }) });
            ok++;
          } catch(e){ console.error(e); fail++; }
        }
        log(`Assign to me done. Success: ${ok}, Failed: ${fail}`);
        await refreshEmails();
      } catch(e){ setError(e.message||String(e)); }
    }

    async function loadUsers(){
      clearError();
      $("userSelect").innerHTML = '<option value="" disabled selected>Loading…</option>';
      try {
        var items = []; var page=1, pageSize=100, data;
        do {
          data = await api(`/api/v2/users?pageSize=${pageSize}&pageNumber=${page}&state=active`);
          if (data && Array.isArray(data.entities)) {
            data.entities.forEach(u => items.push({ id:u.id, name:u.name, email:u.email }));
          }
          page++;
        } while (data && data.pageCount && page <= data.pageCount);
        items.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
        $("userSelect").innerHTML = ['<option value="" disabled selected>Choose a user</option>']
          .concat(items.map(u=>`<option value="${u.id}">${esc(u.name || '(no name)')}${u.email?(' ('+esc(u.email)+')'):''}</option>`)).join('');
      } catch(e){ setError(e.message||String(e)); $("userSelect").innerHTML = '<option disabled selected>Error loading users</option>'; }
    }

    async function transferToUser(){
      var userId = $("userSelect").value; if (!userId){ log('Pick a user from the list'); return; }
      var sel = selectedRows(); if (!sel.length){ log('Select at least one row'); return; }
      var ok=0,fail=0;
      for (var r of sel){
        try {
          var holder = r.agentParticipantId || r.acdParticipantId; if (!holder){ fail++; continue; }
          await fetch(baseUrl()+`/api/v2/conversations/emails/${r.conversationId}/participants/${holder}/replace`, { method:'POST', headers:{ 'Authorization':'Bearer '+token, 'Content-Type':'application/json' }, body: JSON.stringify({ userId, transferType:'Unattended' }) });
          ok++;
        } catch(e){ console.error(e); fail++; }
      }
      log(`Transfer done. Success: ${ok}, Failed: ${fail}`);
      await refreshEmails();
    }

    async function wrapupAndDisconnect(){
      var codeId = $("wrapupSelect").value; if (!codeId){ log('Choose a wrap-up code first'); return; }
      var sel = selectedRows(); if (!sel.length){ log('Select at least one row'); return; }
      var ok=0,fail=0;
      for (var r of sel){
        try {
          // Choose the participant that currently owns the email leg
          var participantId = (r.owner === 'agent') ? r.agentParticipantId : r.acdParticipantId || r.agentParticipantId || r.acdParticipantId;
          var commId = r.emailCommId;
          if (!commId){
            // Try to locate a communication id for the chosen participant
            var convo = await api(`/api/v2/conversations/${r.conversationId}`);
            var p = (convo.participants||[]).find(x=>x.id===participantId);
            var comms = (p && (p.communications || p.sessions)) || [];
            var emailComm = Array.isArray(comms) ? comms.find(s=>s.mediaType==='email') : null;
            commId = emailComm && (emailComm.id || emailComm.sessionId || emailComm.communicationId);
          }
          if (!participantId || !commId){
            log(`Conversation ${r.conversationId}: could not locate an email leg on agent/ACD participant.`);
            fail++; continue;
          }
          // Apply communication-level wrap-up (works for agent or ACD leg)
          var w = await fetch(baseUrl()+`/api/v2/conversations/emails/${r.conversationId}/participants/${participantId}/communications/${commId}/wrapup`, { method:'POST', headers:{ 'Authorization':'Bearer '+token, 'Content-Type':'application/json' }, body: JSON.stringify({ code: codeId }) });
          if (!w.ok) { throw new Error(await w.text()); }
          // Disconnect that participant leg
          var d = await fetch(baseUrl()+`/api/v2/conversations/emails/${r.conversationId}/participants/${participantId}`, { method:'PATCH', headers:{ 'Authorization':'Bearer '+token, 'Content-Type':'application/json' }, body: JSON.stringify({ state:'disconnected' }) });
          if (!d.ok) { throw new Error(await d.text()); }
          ok++;
        } catch(e){ console.error(e); fail++; }
      }
      log(`Wrap-up + disconnect done. Success: ${ok}, Failed: ${fail}`);
      await refreshEmails();
    }

    async function enrichRowDetails(conversationId, tr){
      try {
        // Try the conversations/emails endpoint first for richer email metadata
        var detailRes = await api(`/api/v2/conversations/emails/${conversationId}`);
        var parts = (detailRes && detailRes.participants) || [];
        if (!parts.length){
          // Fallback to generic conversation details
          detailRes = await api(`/api/v2/conversations/${conversationId}`);
          parts = (detailRes && detailRes.participants) || [];
        }
        var external = parts.find(p=>p.purpose==='external');
        var owner = parts.find(p=>p.purpose==='agent' || p.purpose==='user') || parts.find(p=>p.purpose==='acd');
        var comms = (owner && (owner.communications || owner.sessions)) || [];
        var emailComm = Array.isArray(comms) ? comms.find(s=>s.mediaType==='email') : null;
        var subject = (emailComm && (emailComm.subject || emailComm.emailSubject || (emailComm.additionalProperties && emailComm.additionalProperties.subject))) || '';
        var from = (external && (external.address || external.email || external.name)) || '';
        if (subject) tr.querySelector('.cell-subject').textContent = subject;
        if (from) tr.querySelector('.cell-from').textContent = from;
        var r = JSON.parse(tr.dataset.payload);
        r.subject = subject || r.subject; r.from = from || r.from;
        tr.dataset.payload = JSON.stringify(r);
        filterRows();
      } catch(e){ /* ignore enrichment failures */ }
    }

    function filterRows(){
      var fs = ($("filterSubject").value||'').toLowerCase();
      var ff = ($("filterFrom").value||'').toLowerCase();
      Array.from(document.querySelectorAll('#rows tr')).forEach(tr => {
        var r = JSON.parse(tr.dataset.payload);
        var sOk = !fs || (r.subject||'').toLowerCase().includes(fs);
        var fOk = !ff || (r.from||'').toLowerCase().includes(ff);
        tr.style.display = (sOk && fOk) ? '' : 'none';
      });
    }
  </script>
</body>
</html>
