<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Genesys Cloud – Email Bulk Actions (Implicit, Preset)</title>
  <style>
    :root { --bg:#0b0d10; --card:#11151a; --muted:#9aa4b2; --text:#e6edf3; --bad:#ff6b7a; --good:#2ec27e; }
    html, body { height:100%; background:var(--bg); color:var(--text); }
    body { margin:0; font-family:Arial,Helvetica,sans-serif; }
    .banner { background:#12263a; padding:10px 16px; text-align:center; border-bottom:1px solid #21344c; }
    .banner strong { color:#9effb3; }
    .container { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    .card { background: var(--card); border: 1px solid #1f2630; border-radius: 16px; box-shadow: 0 10px 20px rgba(0,0,0,.35); }
    .header { padding: 20px 20px 0 20px; display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
    .title { font-weight:700; font-size:20px; letter-spacing:.2px; }
    .content { padding:20px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    label { font-size:12px; color:var(--muted); display:block; margin-bottom:6px; }
    input, select, textarea, button { width:100%; box-sizing:border-box; border-radius:10px; border:1px solid #263041; background:#0e1217; color:var(--text); padding:10px 12px; }
    button { background:#1a2330; cursor:pointer; }
    button:hover { background:#1e2a3a; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .muted { color:var(--muted); font-size:12px; }
    .pill { display:inline-flex; align-items:center; gap:8px; border:1px solid #2a3446; padding:8px 10px; border-radius:999px; background:#0e1217; font-size:12px; }
    .err { color:var(--bad); white-space:pre-wrap; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:8px 6px; border-bottom:1px solid #253248; vertical-align:top; font-size:13px; }
    th { text-align:left; color:var(--muted); }
    .mono { font-family:Consolas,Menlo,monospace; }
    a.button { display:inline-block; padding:10px 14px; border-radius:8px; border:1px solid #263041; background:#1a2330; color:#e6edf3; text-decoration:none; }
    a.button:hover { background:#1e2a3a; }
  </style>
</head>
<body>
  <div class="banner"><strong>Implicit Grant</strong> — Preset Region & Client; queues loaded from API</div>
  <div class="container">
    <div class="card">
      <div class="header">
        <div class="title">Email Bulk Actions</div>
        <div class="row" style="max-width:620px">
          <a id="signinLink" class="button" href="https://login.mypurecloud.jp/oauth/authorize?client_id=5ad8dc1d-2ee1-41dd-9771-1c0e58f22203&amp;response_type=token&amp;redirect_uri=https%3A%2F%2Fchinarn.github.io%2Femailwizard%2F&amp;state=email_bulk_implicit" target="_self" rel="nofollow noopener">Sign in</a>
          <noscript><div class="muted" style="margin-top:6px">JavaScript is disabled. Use the button above to sign in.</div></noscript>
          <button id="signoutBtn" style="display:none">Sign out</button>
        </div>
      </div>
      <div class="content">
        <div class="row">
          <div style="flex:2">
            <label>OAuth Access Token</label>
            <input id="token" readonly placeholder="Sign in to populate automatically" />
            <div class="muted" id="whoami"></div>
          </div>
          <div style="flex:1">
            <label>Queue</label>
            <select id="queueSelect" disabled>
              <option value="" disabled selected>Sign in first</option>
            </select>
            <div class="muted" id="queueCount"></div>
          </div>
          <div style="flex:1">
            <label>Wrap-up code</label>
            <select id="wrapupSelect" disabled>
              <option value="" disabled selected>Select a queue first</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <button id="refreshBtn" disabled>Refresh Emails</button>
          <button id="assignMeBtn" disabled>Assign to me</button>
          <div class="row" style="flex:2">
            <div style="flex:1">
              <label class="muted">Filter by Subject</label>
              <input id="filterSubject" placeholder="Type to filter…" />
            </div>
            <div style="flex:1">
              <label class="muted">Filter by From</label>
              <input id="filterFrom" placeholder="Type to filter…" />
            </div>
          </div>
          <div class="row" style="flex:1">
            <div style="flex:1">
              <label class="muted">Transfer to user</label>
              <select id="userSelect" disabled>
                <option value="" disabled selected>Load users…</option>
              </select>
            </div>
            <div style="align-self:flex-end">
              <button id="loadUsersBtn" disabled>Load Users</button>
            </div>
            <div style="align-self:flex-end">
              <button id="transferBtn" disabled>Transfer to selected</button>
            </div>
          </div>
          <button id="wrapDiscBtn" disabled style="background:#52202a">Wrap-up + Disconnect</button>
        </div>

        <div class="muted" style="margin-top:6px">Lists <span class="pill">in-progress</span> email interactions from the selected queue (last 2 hours).</div>

        <div style="margin-top:12px; max-height:52vh; overflow:auto">
          <table>
            <thead>
              <tr>
                <th style="width:26px"><input type="checkbox" id="checkAll" /></th>
                <th>Subject</th>
                <th>From</th>
                <th>ConversationId</th>
                <th>Agent/ACD ParticipantId</th>
                <th>CommId</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>

        <div style="margin-top:12px">
          <label>Run Log</label>
          <textarea id="log" rows="8" readonly></textarea>
        </div>
        <div style="margin-top:8px" id="errors" class="err"></div>
      </div>
    </div>
  </div>

  <script>
    // ======== CONFIG (Preset) ========
    var REGION_HOST  = 'mypurecloud.jp';
    var CLIENT_ID    = '5ad8dc1d-2ee1-41dd-9771-1c0e58f22203';
    var REDIRECT_URI = 'https://chinarn.github.io/emailwizard/'; // must match OAuth app exactly
    var OAUTH_STATE  = 'email_bulk_implicit';
    // =================================

    function $(id){ return document.getElementById(id); }
    var token = '';
    function baseUrl(){ return 'https://api.' + REGION_HOST; }

    function log(line){
      var t = $('log'); var s = new Date().toLocaleTimeString();
      t.value = (t.value ? t.value + '
' : '') + s + ' • ' + line; t.scrollTop = t.scrollHeight;
    }
    function setError(msg){ $('errors').textContent = msg || ''; }
    function clearError(){ setError(''); }

    function buildAuthUrl(){
      var base = 'https://login.' + REGION_HOST + '/oauth/authorize';
      var q = 'client_id=' + encodeURIComponent(CLIENT_ID)
            + '&response_type=token'
            + '&redirect_uri=' + encodeURIComponent(REDIRECT_URI)
            + '&state=' + encodeURIComponent(OAUTH_STATE);
      return base + '?' + q;
    }
    function readTokenFromHash(){
      if (!location.hash) return null;
      var p = new URLSearchParams(location.hash.substring(1));
      var t = p.get('access_token');
      if (t){ history.replaceState({}, document.title, window.location.pathname + window.location.search); }
      return t ? { access_token:t } : null;
    }

    function updateSigninState(){
      var signedIn = !!token;
      $('signinLink').style.display = signedIn ? 'none' : 'inline-block';
      $('signoutBtn').style.display = signedIn ? 'inline-block' : 'none';
      ['refreshBtn','assignMeBtn','transferBtn','loadUsersBtn'].forEach(function(id){ var el=$(id); if(el) el.disabled = !signedIn; });
      $('queueSelect').disabled = !signedIn;
      $('wrapupSelect').disabled = !signedIn || !$('queueSelect').value;
      $('wrapDiscBtn').disabled = !signedIn || !$('queueSelect').value;
      $('userSelect').disabled = !signedIn;
      $('token').value = token || '';
    }

    // Anchor-based sign-in (less brittle than programmatic nav)
    function wireSigninLink(){ /* Not needed: anchor is now hard-coded for reliability */ }

    $('signoutBtn').addEventListener('click', function(){ token=''; $('rows').innerHTML=''; $('queueSelect').innerHTML='<option disabled selected>Sign in first</option>'; $('wrapupSelect').innerHTML='<option disabled selected>Select a queue first</option>'; updateSigninState(); $('whoami').textContent=''; $('queueCount').textContent=''; $('log').value=''; $('userSelect').innerHTML='<option value="" disabled selected>Load users…</option>'; });

    window.addEventListener('error', function(e){ setError(e && e.message ? e.message : 'Script error'); });
    window.addEventListener('unhandledrejection', function(e){ setError('Promise rejection: ' + (e && e.reason && e.reason.message ? e.reason.message : String(e.reason))); });

    (function init(){
      log('App loaded. Redirect URI: ' + REDIRECT_URI); // Anchor already hard-coded; no runtime wiring
      var th = readTokenFromHash();
      if (th){ token = th.access_token; log('Token received.'); }
      updateSigninState();
      if (token) bootstrap();
      $('queueSelect').addEventListener('change', function(){ loadWrapupsForQueue(this.value); $('wrapupSelect').disabled = !this.value; $('wrapDiscBtn').disabled = !this.value; filterRows(); });
      $('refreshBtn').addEventListener('click', refreshEmails);
      $('assignMeBtn').addEventListener('click', assignToMe);
      $('transferBtn').addEventListener('click', transferToUser);
      $('loadUsersBtn').addEventListener('click', loadUsers);
      $('wrapDiscBtn').addEventListener('click', wrapupAndDisconnect);
      $('checkAll').addEventListener('change', function(e){ var cbs=document.querySelectorAll('#rows input[type="checkbox"]'); for (var i=0;i<cbs.length;i++){ cbs[i].checked = e.target.checked; } });
      $('filterSubject').addEventListener('input', filterRows);
      $('filterFrom').addEventListener('input', filterRows);
    })();

    async function api(path, init){
      if (!token) throw new Error('Missing OAuth token');
      var res = await fetch(baseUrl() + path, Object.assign({}, init||{}, { headers: Object.assign({ 'Authorization':'Bearer '+token, 'Content-Type':'application/json' }, (init && init.headers) || {}) }));
      if (!res.ok){ var text = await res.text(); throw new Error(res.status + ' ' + res.statusText + ': ' + text); }
      return res.json();
    }

    async function bootstrap(){
      try{
        var me = await api('/api/v2/users/me');
        $('whoami').textContent = 'Signed in as ' + me.name + ' (' + me.id + ') · ' + REGION_HOST;
        log('Authenticated');
        $('loadUsersBtn').disabled = false;
        await loadQueues();
      }catch(e){ setError(e.message || String(e)); }
    }

    async function loadQueues(){
      clearError();
      $('queueSelect').innerHTML = '<option value="" disabled selected>Loading…</option>';
      try{
        var items = []; var page=1, pageSize=100, data;
        do{
          data = await api('/api/v2/routing/queues?pageSize=' + pageSize + '&pageNumber=' + page);
          if (data && data.entities){ for (var i=0;i<data.entities.length;i++){ var q=data.entities[i]; items.push({ id:q.id, name:q.name }); } }
          page++;
        }while(data && data.pageCount && page <= data.pageCount);
        items.sort(function(a,b){ return (a.name||'').localeCompare(b.name||''); });
        var html = '<option value="" disabled selected>Choose a queue</option>';
        for (var j=0;j<items.length;j++){ html += '<option value="' + items[j].id + '">' + items[j].name + '</option>'; }
        $('queueSelect').innerHTML = html;
        $('queueCount').textContent = items.length ? (items.length + ' queues loaded') : 'No queues';
        updateSigninState();
      }catch(e){ setError(e.message || String(e)); $('queueSelect').innerHTML = '<option disabled selected>Error loading queues</option>'; }
    }

    async function loadWrapupsForQueue(queueId){
      $('wrapupSelect').innerHTML = '<option value="" disabled selected>Loading…</option>';
      try{
        var items = []; var page=1, pageSize=100, data;
        do{
          data = await api('/api/v2/routing/queues/' + queueId + '/wrapupcodes?pageSize=' + pageSize + '&pageNumber=' + page);
          if (data && data.entities){ for (var i=0;i<data.entities.length;i++){ var c=data.entities[i]; items.push({ id:c.id, name:c.name }); } }
          page++;
        }while(data && data.pageCount && page <= data.pageCount);
        if (!items.length){ $('wrapupSelect').innerHTML = '<option value="" disabled selected>No wrap-up codes on this queue</option>'; return; }
        items.sort(function(a,b){ return (a.name||'').localeCompare(b.name||''); });
        var html = '<option value="" disabled selected>(choose wrap-up code)</option>';
        for (var j=0;j<items.length;j++){ html += '<option value="' + items[j].id + '">' + items[j].name + ' — ' + items[j].id + '</option>'; }
        $('wrapupSelect').innerHTML = html;
      }catch(e){ setError(e.message || String(e)); $('wrapupSelect').innerHTML = '<option disabled selected>Wrap-up codes unavailable</option>'; }
    }

    function selectedRows(){
      var trs = document.querySelectorAll('#rows tr'); var out=[];
      for (var i=0;i<trs.length;i++){ var tr=trs[i]; var cb=tr.querySelector('input[type="checkbox"]'); if (cb && cb.checked){ out.push(JSON.parse(tr.dataset.payload)); } }
      return out;
    }

    async function refreshEmails(){
      var queueId = $('queueSelect').value; if (!queueId){ log('Pick a queue first'); return; }
      $('rows').innerHTML = ''; log('Loading emails…');
      try{
        var end = new Date().toISOString();
        var start = new Date(Date.now() - 2*60*60*1000).toISOString();
        var body = { interval: start + '/' + end, order:'desc', orderBy:'conversationStart', paging:{ pageNumber:1, pageSize:100 }, segmentFilters:[ { type:'and', predicates:[ { type:'dimension', dimension:'queueId', operator:'matches', value: queueId }, { type:'dimension', dimension:'mediaType', operator:'matches', value:'email' } ] } ] };
        var res = await fetch(baseUrl() + '/api/v2/analytics/conversations/details/query', { method:'POST', headers:{ 'Authorization':'Bearer '+token, 'Content-Type':'application/json' }, body: JSON.stringify(body) });
        if (!res.ok){ throw new Error(res.status + ' ' + res.statusText + ': ' + (await res.text())); }
        var data = await res.json();
        var convs = (data && data.conversations) ? data.conversations : [];
        var rows = [];
        for (var i=0;i<convs.length;i++){
          var c = convs[i]; if (c.conversationEnd) continue; rows.push(marshalRow(c));
        }
        for (var r=0;r<rows.length;r++){ addRow(rows[r]); }
        log('Loaded ' + rows.length + ' in-progress emails');
        $('checkAll').checked = false; filterRows();
      }catch(e){ setError(e.message || String(e)); }
    }

    function marshalRow(c){
      var parts = c.participants || [];
      var external = null, agent = null, acd = null;
      for (var i=0;i<parts.length;i++){
        var p = parts[i];
        if (p.purpose === 'external') external = p;
        else if (p.purpose === 'agent' || p.purpose === 'user') agent = p;
        else if (p.purpose === 'acd') acd = p;
      }
      function firstEmailSess(p){ var s = (p && (p.sessions||p.communications)) || []; for (var i=0;i<s.length;i++){ if (s[i] && s[i].mediaType === 'email') return s[i]; } return null; }
      var aSess = firstEmailSess(agent);
      var acdSess = firstEmailSess(acd);
      var comm = aSess || acdSess || null;
      return {
        conversationId: c.conversationId,
        subject: (comm && (comm.subject || comm.emailSubject)) || '',
        from: (external && (external.address || external.email || external.name)) || '',
        agentParticipantId: (agent && agent.participantId) || null,
        acdParticipantId: (acd && acd.participantId) || null,
        emailCommId: (comm && (comm.sessionId || comm.communicationId || comm.id)) || null,
        owner: aSess ? 'agent' : (acdSess ? 'acd' : null)
      };
    }

    function addRow(r){
      var tr = document.createElement('tr');
      tr.innerHTML = '<td><input type="checkbox"></td>'+
        '<td class="cell-subject">' + esc(r.subject||'') + '</td>'+
        '<td class="cell-from">' + esc(r.from||'') + '</td>'+
        '<td class="mono">' + esc(r.conversationId) + '</td>'+
        '<td class="mono">' + esc(r.agentParticipantId || r.acdParticipantId || '') + '</td>'+
        '<td class="mono">' + esc(r.emailCommId || '') + '</td>';
      tr.dataset.payload = JSON.stringify(r);
      $('rows').appendChild(tr);
      if (!r.subject || !r.from) enrichRowDetails(r.conversationId, tr);
    }

    function esc(s){ return (s||'').toString().replace(/[&<>"']/g, function(c){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]; }); }

    async function assignToMe(){
      var sel = selectedRows(); if (!sel.length){ log('Select at least one row'); return; }
      try{
        var me = await api('/api/v2/users/me'); var ok=0, fail=0;
        for (var i=0;i<sel.length;i++){
          var r = sel[i]; try{
            var holder = r.agentParticipantId || r.acdParticipantId; if (!holder){ fail++; continue; }
            var res = await fetch(baseUrl() + '/api/v2/conversations/emails/' + r.conversationId + '/participants/' + holder + '/replace', { method:'POST', headers:{ 'Authorization':'Bearer '+token, 'Content-Type':'application/json' }, body: JSON.stringify({ userId: me.id, transferType:'Unattended' }) });
            if (!res.ok) throw new Error(await res.text()); ok++;
          }catch(e){ fail++; }
        }
        log('Assign to me done. Success: ' + ok + ', Failed: ' + fail);
        await refreshEmails();
      }catch(e){ setError(e.message || String(e)); }
    }

    async function loadUsers(){
      clearError(); $('userSelect').innerHTML = '<option value="" disabled selected>Loading…</option>';
      try{
        var items = []; var page=1, pageSize=100, data;
        do{
          data = await api('/api/v2/users?pageSize=' + pageSize + '&pageNumber=' + page + '&state=active');
          if (data && data.entities){ for (var i=0;i<data.entities.length;i++){ var u=data.entities[i]; items.push({ id:u.id, name:u.name, email:u.email }); } }
          page++;
        }while(data && data.pageCount && page <= data.pageCount);
        items.sort(function(a,b){ return (a.name||'').localeCompare(b.name||''); });
        var html = '<option value="" disabled selected>Choose a user</option>';
        for (var j=0;j<items.length;j++){ var u=items[j]; html += '<option value="' + u.id + '">' + esc(u.name||'(no name)') + (u.email?(' ('+esc(u.email)+')'):'') + '</option>'; }
        $('userSelect').innerHTML = html;
        $('transferBtn').disabled = false;
      }catch(e){ setError(e.message || String(e)); $('userSelect').innerHTML = '<option disabled selected>Error loading users</option>'; }
    }

    async function transferToUser(){
      var userId = $('userSelect').value; if (!userId){ log('Pick a user from the list'); return; }
      var sel = selectedRows(); if (!sel.length){ log('Select at least one row'); return; }
      var ok=0, fail=0;
      for (var i=0;i<sel.length;i++){
        var r = sel[i]; try{
          var holder = r.agentParticipantId || r.acdParticipantId; if (!holder){ fail++; continue; }
          var res = await fetch(baseUrl() + '/api/v2/conversations/emails/' + r.conversationId + '/participants/' + holder + '/replace', { method:'POST', headers:{ 'Authorization':'Bearer '+token, 'Content-Type':'application/json' }, body: JSON.stringify({ userId: userId, transferType:'Unattended' }) });
          if (!res.ok) throw new Error(await res.text()); ok++;
        }catch(e){ fail++; }
      }
      log('Transfer done. Success: ' + ok + ', Failed: ' + fail);
      await refreshEmails();
    }

    async function wrapupAndDisconnect(){
      var codeId = $('wrapupSelect').value; if (!codeId){ log('Choose a wrap-up code first'); return; }
      var sel = selectedRows(); if (!sel.length){ log('Select at least one row'); return; }
      var ok=0, fail=0;
      for (var i=0;i<sel.length;i++){
        var r = sel[i]; try{
          var participantId = r.owner === 'agent' ? r.agentParticipantId : (r.acdParticipantId || r.agentParticipantId || r.acdParticipantId);
          var commId = r.emailCommId;
          if (!commId){
            var convo = await api('/api/v2/conversations/' + r.conversationId);
            var p = null; var parts = convo && convo.participants ? convo.participants : [];
            for (var k=0;k<parts.length;k++){ if (parts[k].id === participantId){ p = parts[k]; break; } }
            var sacks = (p && (p.communications || p.sessions)) || [];
            for (var s=0;s<sacks.length;s++){ var x=sacks[s]; if (x && x.mediaType==='email'){ commId = x.id || x.sessionId || x.communicationId; if (commId) break; } }
          }
          if (!participantId || !commId){ log('Conversation ' + r.conversationId + ': could not locate an email leg on agent/ACD participant.'); fail++; continue; }
          var w = await fetch(baseUrl() + '/api/v2/conversations/emails/' + r.conversationId + '/participants/' + participantId + '/communications/' + commId + '/wrapup', { method:'POST', headers:{ 'Authorization':'Bearer '+token, 'Content-Type':'application/json' }, body: JSON.stringify({ code: codeId }) });
          if (!w.ok) throw new Error(await w.text());
          var d = await fetch(baseUrl() + '/api/v2/conversations/emails/' + r.conversationId + '/participants/' + participantId, { method:'PATCH', headers:{ 'Authorization':'Bearer '+token, 'Content-Type':'application/json' }, body: JSON.stringify({ state:'disconnected' }) });
          if (!d.ok) throw new Error(await d.text());
          ok++;
        }catch(e){ fail++; }
      }
      log('Wrap-up + disconnect done. Success: ' + ok + ', Failed: ' + fail);
      await refreshEmails();
    }

    async function enrichRowDetails(conversationId, tr){
      try{
        var convo = await api('/api/v2/conversations/' + conversationId);
        var parts = convo && convo.participants ? convo.participants : [];
        function scan(p){
          var sacks = (p && (p.communications || p.sessions)) || []; var subj='', from='', commId=null;
          for (var i=0;i<sacks.length;i++){
            var s = sacks[i]; if (!s || s.mediaType !== 'email') continue;
            if (!subj) subj = s.subject || s.emailSubject || (s.additionalProperties && (s.additionalProperties.subject || s.additionalProperties.Subject)) || (s.headers && (s.headers.subject || s.headers.Subject)) || '';
            if (!from) from = s.fromAddress || s.fromEmail || s.from || (s.additionalProperties && (s.additionalProperties.from || s.additionalProperties.From)) || '';
            if (!commId) commId = s.id || s.sessionId || s.communicationId || null;
          }
          return { subj:subj, from:from, commId:commId };
        }
        var external=null, agent=null, acd=null;
        for (var j=0;j<parts.length;j++){ var p=parts[j]; if (p.purpose==='external') external=p; else if (p.purpose==='agent' || p.purpose==='user') agent=p; else if (p.purpose==='acd') acd=p; }
        var scA = scan(agent); var scQ = scan(acd);
        var subj = scA.subj || scQ.subj || '';
        var from = scA.from || scQ.from || (external && (external.address || external.email)) || '';
        var commId = scA.commId || scQ.commId || null;
        if (subj) tr.querySelector('.cell-subject').textContent = subj;
        if (from) tr.querySelector('.cell-from').textContent = from;
        var r = JSON.parse(tr.dataset.payload); r.subject = subj || r.subject; r.from = from || r.from; r.emailCommId = commId || r.emailCommId; tr.dataset.payload = JSON.stringify(r);
        filterRows();
      }catch(e){ /* ignore */ }
    }

    function filterRows(){
      var fs = ($('filterSubject').value||'').toLowerCase();
      var ff = ($('filterFrom').value||'').toLowerCase();
      var trs = document.querySelectorAll('#rows tr');
      for (var i=0;i<trs.length;i++){
        var r = JSON.parse(trs[i].dataset.payload || '{}');
        var sOk = !fs || ((r.subject||'').toLowerCase().indexOf(fs) !== -1);
        var fOk = !ff || ((r.from||'').toLowerCase().indexOf(ff) !== -1);
        trs[i].style.display = (sOk && fOk) ? '' : 'none';
      }
    }
  </script>
</body>
</html>
